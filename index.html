<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <!-- Mobile browser chrome colour (matches dark background) -->
    <meta name="theme-color" content="#071029" />
    <title>Stewart / Figge — acid–base calculator</title>
    <link rel="icon" type="image/svg+xml" href="./favicon.svg" />
    <link rel="stylesheet" href="./style.css" />
  </head>
  <body>
    <!-- ═══════════════════════════════════════════════════════════
         Main container — single-column card layout
         ═══════════════════════════════════════════════════════════ -->
    <main class="container">
      <h1>Stewart / Figge — acid–base calculator</h1>
      <p class="muted">Static demo — not for clinical use. Reproduces inputs &amp; core outputs (SIDa, SIDe, SIG, AG). At physiologically normal values (albumin 42 g/L, pH 7.40, pCO₂ 40 mmHg, phosphate 1.0 mmol/L) the model gives SIG ≈ 5 mEq/L — this reflects real unmeasured anions in normal plasma (sulfate, acetate, citrate, etc.) that are absent from SIDa but present in SIDe. <strong>Normal SIG range: 0–6 mEq/L.</strong></p>

      <!-- ── Global toggles ── -->
      <div class="toolbar">
        <label><input id="show-non-si" type="checkbox"> Show non‑SI units</label>
        <label><input id="toggle-light" type="checkbox"> Light mode</label>
      </div>

      <!-- ═══════════════════════════════════════════════════════════
           Input + results grid (single-column flex layout)
           ═══════════════════════════════════════════════════════════ -->
      <section class="grid">

        <!-- ── Strong cations ── -->
        <fieldset>
          <legend>Strong cations</legend>

          <label><span class="ion-label">Na<sup>+</sup> (mmol/L)<span class="muted">, Ref. 135–145</span></span>
            <select id="na-picker" class="picker" aria-label="Na picker"></select>
          </label>

          <label><span class="ion-label">K<sup>+</sup> (mmol/L)<span class="muted">, Ref. 3.5–5.0</span></span>
            <select id="k-picker" class="picker" aria-label="K picker"></select>
          </label>

          <label><span class="ion-label">iCa<sup>2+</sup><span class="muted">, Ref. 1.15–1.29 mmol/L (4.6–5.3 mg/dL)</span></span>
            <select id="ica-unit" class="unit-select"><option value="si">mmol/L</option><option value="mgdl">mg/dL</option></select>
            <select id="ica-picker" class="picker" aria-label="iCa picker"></select>
          </label>

          <label><span class="ion-label">Mg<sup>2+</sup><span class="muted">, Ref. 1.7–2.2 mg/dL (0.70–0.95 mmol/L)</span></span>
            <select id="mg-unit" class="unit-select"><option value="mgdl">mg/dL</option><option value="si">mmol/L</option></select>
            <select id="mg-picker" class="picker" aria-label="Mg picker"></select>
          </label>
        </fieldset>

        <!-- ── Strong anions ── -->
        <fieldset>
          <legend>Strong anions</legend>

          <label><span class="ion-label">Cl<sup>−</sup> (mmol/L)<span class="muted">, Ref. 98–107</span></span>
            <select id="cl-picker" class="picker" aria-label="Cl picker"></select>
          </label>

          <label><span class="ion-label">Lactate<sup>−</sup><span class="muted">, Ref. 0.5–2.0 mmol/L (4.5–18 mg/dL)</span></span>
            <select id="lac-unit" class="unit-select"><option value="si">mmol/L</option><option value="mgdl">mg/dL</option></select>
            <select id="lac-picker" class="picker" aria-label="Lactate picker"></select>
          </label>
        </fieldset>

        <!-- ── Weak acids ── -->
        <fieldset>
          <legend>Weak acids</legend>
          <label><span class="ion-label">Albumin (g/dL)<span class="muted">, Ref. 3.5–5.0</span></span>
            <select id="alb-picker" class="picker" aria-label="Albumin picker"></select>
          </label>

          <label><span class="ion-label">Phosphate<span class="muted">, Ref. 0.8–1.45 mmol/L (2.5–4.5 mg/dL)</span></span>
            <select id="phos-unit" class="unit-select"><option value="si">mmol/L</option><option value="mgdl">mg/dL</option></select>
            <select id="phos-picker" class="picker" aria-label="Phosphate picker"></select>
          </label>

          <label><span class="ion-label">HCO<sub>3</sub><sup>−</sup> (mmol/L)<span class="muted">, Ref. 22–26</span></span><input id="hco3" type="number" step="0.1" placeholder="auto" disabled></label>
          <div class="checkbox-row"><input id="use-bmp-hco3" type="checkbox"><label for="use-bmp-hco3">Use measured BMP HCO<sub>3</sub><sup>−</sup> for Gamblegram (editable)</label></div>
        </fieldset>

        <!-- ── Blood gas ── -->
        <fieldset>
          <legend>Blood‑gas</legend>
          <label><span style="white-space: nowrap;">pH<span class="muted">, Ref. 7.35–7.45</span></span>
            <select id="ph-picker" class="picker" aria-label="pH picker"></select>
          </label>
          <label><span style="white-space: nowrap;">pCO<sub>2</sub> (mmHg)<span class="muted">, Ref. 35–45</span></span>
            <select id="pco2-picker" class="picker" aria-label="pCO2 picker"></select>
          </label>
          <label><span style="white-space: nowrap;">SBE (mmol/L)<span class="muted">, Ref. −2 to +2</span></span><input id="sbe" type="number" step="0.1" placeholder="optional"></label>
        </fieldset>



        <!-- ── Gamblegram (SVG stacked-bar chart) ── -->
        <section class="gamblegram" aria-label="Gamblegram (ion balance)">
          <h2>Gamblegram</h2>
          <div class="gg-canvas">
            <svg id="gg-svg" width="560" height="260" viewBox="0 0 560 260" role="img" aria-labelledby="gg-title gg-desc">
              <title id="gg-title">Gamblegram — strong ions</title>
              <desc id="gg-desc">Stacked cations (left) and anions (right). Unmeasured / unknown quantity highlighted in the legend as "Unknown".</desc>
            </svg>
          </div>
          <div class="gg-info">
            <div id="gg-unknown" class="gg-unknown">Unknown: —</div>
            <div class="gg-legend" id="gg-legend"></div>
            <button id="export-gg" class="btn" title="Export Gamblegram as PNG" style="margin-top:12px;">
              <svg class="btn-icon" viewBox="0 0 24 24" width="16" height="16" aria-hidden="true" focusable="false">
                <path d="M12 3v12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" fill="none"/>
                <path d="M8 11l4 4 4-4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" fill="none"/>
                <path d="M5 20h14" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" fill="none"/>
              </svg>
              Export Gamblegram
            </button>
          </div>
        </section>

        <!-- ── Mobile-only header (moved below Gamblegram) ── -->
        <div class="mobile-header" role="region" aria-label="Mobile summary" aria-hidden="false">
          <div class="mobile-title">Stewart / Figge</div>
          <div class="mobile-summary">
            <div class="mh-item">SIDa <span id="mh-sida">—</span></div>
            <div class="mh-item">SIDe <span id="mh-side">—</span></div>
            <div class="mh-item">SIG <span id="mh-sig">—</span></div>
          </div>
          <div class="mobile-actions"><button id="mh-toggle-formulas" class="compact">Formulas</button></div>
        </div>

        <!-- ── Computed results (moved below Gamblegram) ── -->
        <section class="results compact" aria-live="polite">
          <h2>Results</h2>
          <dl>
            <dt>SIDe</dt><dd id="res-side">—</dd>
            <dt>SIDa</dt><dd id="res-sida">—</dd>
            <dt>SIG</dt><dd id="res-sig">—</dd>
            <dt>AG</dt><dd id="res-ag">—</dd>
          </dl>
          <div class="results-actions">
            <button id="reset">Reset values</button>
          </div>
          <p class="note small-note">Values update live. Use the toggle above to show non‑SI units. <strong>Normal SIG: 0–6 mEq/L.</strong></p>
        </section>

        <!-- ── Formulas panel (collapsible) ── -->
        <section class="formulas collapsed" id="formulas-panel">
          <div class="formulas-header">
            <h3>Formulas used</h3>
            <button id="toggle-formulas" aria-expanded="false" class="collapse-btn">Show</button>
          </div>
          <div class="formulas-body math">\[\begin{aligned}
            \mathrm{SID_a} &= [\mathrm{Na}^+] + [\mathrm{K}^+] + 2[\mathrm{Ca}^{2+}] + 2[\mathrm{Mg}^{2+}] - [\mathrm{Cl}^-] - [\mathrm{Lactate}^-] \\[8pt]
            \mathrm{SID_e} &= [\mathrm{HCO}_3^-] + \mathrm{Alb}^- + \mathrm{Phos}^- \\[8pt]
            \mathrm{SIG} &= \mathrm{SID_a} - \mathrm{SID_e} \\[8pt]
            \mathrm{AG} &= [\mathrm{Na}^+] + [\mathrm{K}^+] - [\mathrm{Cl}^-] - [\mathrm{HCO}_3^-] \\[8pt]
            [\mathrm{HCO}_3^-] &= 0.03\times pCO_2\times 10^{\,\mathrm{pH}\,-\,6.1} \quad\text{(Henderson--Hasselbalch)}\\[10pt]
            \mathrm{Alb}^- &= -\,\frac{[\mathrm{Alb}]_{g/L}}{66.5}\;\sum_i \frac{n_i\,(\pm 1)}{1+10^{\,\pm(pK_{a,i}\,-\,\mathrm{pH})}}\quad\text{(Figge–Fencl v3.0)}\\[10pt]
            \mathrm{Phos}^- &= [\mathrm{PO_4}]\;\frac{K_1[\mathrm{H}^+]^2 + 2K_1K_2[\mathrm{H}^+] + 3K_1K_2K_3}{[\mathrm{H}^+]^3 + K_1[\mathrm{H}^+]^2 + K_1K_2[\mathrm{H}^+] + K_1K_2K_3}\\[12pt]
            \textbf{Definitions:}\\[4pt]
            n_i &\;=\; \text{stoichiometric charge contribution of site }i\; (\pm 1;\text{ e.g. His, Lys, Asp/Glu})\\[6pt]
            pK_{a,i} &\;=\; \text{site-specific acid dissociation constant for residue }i\\[6pt]
            K_j &\;=\;10^{-pK_j}\;\text{(so }K_1,K_2,K_3\text{ are phosphate dissociation constants)}\\[6pt]
            [\mathrm{PO_4}] &\;=\;\text{total inorganic phosphate (mmol/L)}\\[6pt]
            [\mathrm{Alb}]_{g/L} &\;=\;\text{albumin concentration in g/L (use g/dL × 10)}\\[6pt]
            \alpha &\;=\;0.03\;\mathrm{L\cdot mmHg^{-1}}\;\text{(CO}_2\text{ solubility at 37\,°C)}\\[6pt]
            \text{Sum over }i &\;\text{runs over albumin titratable residues (His, Lys, Arg, Asp/Glu, Tyr, N/C termini); Site pK values follow Figge\u2013Fencl v3.0 (implemented in }js/physiology.js\text{).}\\[6pt]
          \end{aligned}\]</div>
        </section>
      </section>

      <!-- ── References ── -->
      <section class="references">
        <h3>References</h3>
        <ol>
          <li id="ref-1">
            Figge J, Mydosh T, Fencl V.
            <cite>Serum proteins and acid-base equilibria: a follow-up.</cite>
            J Lab Clin Med. 1992;120(5):713-719.
            <a href="https://pubmed.ncbi.nlm.nih.gov/1431500/" target="_blank" rel="noopener">PubMed&nbsp;1431500</a>
          </li>
          <li id="ref-2">
            Figge J.
            <cite>Figge-Fencl quantitative physicochemical model of human acid-base physiology (v3.0).</cite>
            2003–2013.
            <a href="https://web.archive.org/web/20160327122156/http://figge-fencl.org/model.html" target="_blank" rel="noopener">figge-fencl.org (archived)</a>
          </li>
          <li id="ref-3">
            Stewart PA.
            <cite>Modern quantitative acid-base chemistry.</cite>
            Can J Physiol Pharmacol. 1983;61(12):1444-1461.
            <a href="https://pubmed.ncbi.nlm.nih.gov/6423247/" target="_blank" rel="noopener">PubMed&nbsp;6423247</a>
          </li>
          <li id="ref-4">
            Kellum JA.
            <cite>Clinical review: reunification of acid-base physiology.</cite>
            Crit Care. 2005;9(5):500-507.
            <a href="https://pubmed.ncbi.nlm.nih.gov/16277737/" target="_blank" rel="noopener">PubMed&nbsp;16277737</a>
          </li>
          <li id="ref-5">
            Sendroy J Jr, Hastings AB.
            <cite>Studies of the solubility of calcium salts. III.</cite>
            J Biol Chem. 1927;71:797-823.
            (Phosphoric acid apparent dissociation constants for plasma, 37 °C)
          </li>
          <li id="ref-6">
            Fencl V, Jabor A, Kazda A, Figge J.
            <cite>Diagnosis of metabolic acid-base disturbances in critically ill patients.</cite>
            Am J Respir Crit Care Med. 2000;162(6):2246-2251.
            <a href="https://pubmed.ncbi.nlm.nih.gov/11112147/" target="_blank" rel="noopener">PubMed&nbsp;11112147</a>
          </li>
        </ol>
      </section>

      <!-- ── Footer ── -->
      <footer>
        <small>This calculator has not been validated and results might be inaccurate depending on the clinical context and your laboratory reference ranges. Use at your own responsibility. Inspired by <a href="https://medischesnippers.nl/stewart/" target="_blank" rel="noopener">medischesnippers.nl/stewart</a>.</small>
      </footer>

      <!-- Tooltip (positioned absolutely by JS) -->
      <div id="gg-tooltip" class="gg-tooltip" role="tooltip" aria-hidden="true"></div>
    </main>

    <!-- ── Application logic (load order matters — no ES modules) ── -->
    <script src="./js/helpers.js"></script>
    <script src="./js/physiology.js"></script>
    <script src="./js/units.js"></script>
    <script src="./js/gamblegram.js"></script>
    <script src="./js/export.js"></script>
    <script src="./js/compute.js"></script>
    <script src="./js/pickers.js"></script>
    <script src="./js/events.js"></script>
    <!-- MathJax config: left-align display equations -->
    <script>
      MathJax = {
        chtml: { displayAlign: 'left', displayIndent: '0.5em' },
        svg:   { displayAlign: 'left', displayIndent: '0.5em' }
      };
    </script>
    <!-- MathJax — renders the LaTeX formulas panel -->
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
  </body>
</html>